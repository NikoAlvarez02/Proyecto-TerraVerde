{% extends "base.html" %}
{% load static %}

{% block title %}Profesionales | TerraVerde{% endblock %}
{% block topbar_title %}Profesionales{% endblock %}
{% block sidebar %}{% endblock %}

{% block content %}
<div class="main-wrap" style="display:flex; gap:24px;">
  <section class="contenido-principal" style="flex:1;">
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
        <h1 class="main-title" style="margin:0;">Listado de Profesionales</h1>
        <button id="btnNuevo" class="btn btn-guardar">Nuevo Profesional</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px;">
        <input id="pr_q" type="search" placeholder="Buscar DNI / nombre / especialidad" style="padding:6px 10px; min-width:260px;" />
        <select id="pr_esp" style="padding:6px 10px; min-width:200px;"><option value="">Especialidad (todas)</option></select>
        <select id="pr_orden" style="padding:6px 10px;">
          <option value="apellido">Apellido A-Z</option>
          <option value="-apellido">Apellido Z-A</option>
        </select>
        <button id="pr_buscar" class="btn">Filtrar</button>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table class="tabla-listado">
          <thead>
            <tr>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>DNI</th>
              <th>Especialidad</th>
              <th>Teléfono</th>
              <th>Centros</th>
              <th style="width:1%; white-space:nowrap;"></th>
            </tr>
          </thead>
          <tbody id="profesionales-tbody">
            <tr><td colspan="7">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px;">
        <button id="pr_prev" class="btn">Anterior</button>
        <span id="pr_pageInfo" style="color:#666;"></span>
        <button id="pr_next" class="btn">Siguiente</button>
      </div>

      <div id="flash" style="margin-top:12px; display:none;"></div>
    </div>
  </section>
</div>

<!-- Modal Crear/Editar -->
<div id="modalForm" class="modal">
  <div class="card modal-card">
    <div class="modal-header drag-handle">
      <div class="title-wrap">
        <h2 id="modalTitle" class="main-title" style="color:#fff;">Nuevo Profesional</h2>
        <p>Registra o edita la información del profesional.</p>
      </div>
      <button id="btnCerrarModal" class="modal-close" aria-label="Cerrar modal">✕</button>
    </div>

    <div class="modal-body">
      <form id="formProfesional" class="form-modal">
        {% csrf_token %}
        <input type="hidden" id="profesionalId">

        <div class="form-grid">
          <div>
            <label>Apellido</label>
            <input type="text" id="apellido" name="apellido" required>
          </div>
          <div>
            <label>Nombre</label>
            <input type="text" id="nombre" name="nombre" required>
          </div>
          <div>
            <label>DNI</label>
            <input type="text" id="dni" name="dni" required>
          </div>
          <div>
            <label>Matrícula</label>
            <input type="text" id="matricula" name="matricula">
          </div>
          <div>
            <label>Especialidad</label>
            <select id="especialidad" name="especialidad"></select>
          </div>
          <div>
            <label>Teléfono</label>
            <input type="text" id="telefono" name="telefono">
          </div>
          <div>
            <label>Email</label>
            <input type="email" id="email" name="email">
          </div>
          <div class="col-span-2">
            <label>Dirección</label>
            <input type="text" id="direccion" name="direccion">
          </div>
          <div class="col-span-2">
            <label>
              <input type="checkbox" id="activo" name="activo" checked> Activo
            </label>
          </div>
        </div>
      </form>

      <!-- Gestión de horarios por centro -->
      <div id="horariosWrap" style="margin-top:18px; border-top:1px solid #eee; padding-top:14px; display:none;">
        <h3 style="margin:0 0 10px;">Horarios por Centro</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr; gap:10px; align-items:end;">
          <div>
            <label>Centro</label>
            <select id="h_centro"></select>
          </div>
          <div>
            <label>Día</label>
            <select id="h_dia">
              <option value="0">Lunes</option>
              <option value="1">Martes</option>
              <option value="2">Miércoles</option>
              <option value="3">Jueves</option>
              <option value="4">Viernes</option>
              <option value="5">Sábado</option>
              <option value="6">Domingo</option>
            </select>
          </div>
          <div>
            <label>Hora inicio</label>
            <input type="time" id="h_inicio" />
          </div>
          <div>
            <label>Hora fin</label>
            <input type="time" id="h_fin" />
          </div>
          <div style="display:flex; gap:8px;">
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="h_activo" checked /> Activo
            </label>
            <button id="h_agregar" class="btn" type="button">Agregar</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px;">
          <table class="tabla-listado">
            <thead>
              <tr>
                <th>Centro</th>
                <th>Día</th>
                <th>Desde</th>
                <th>Hasta</th>
                <th>Activo</th>
                <th style="width:1%; white-space:nowrap;"></th>
              </tr>
            </thead>
            <tbody id="horarios-tbody">
              <tr><td colspan="6">Sin horarios</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="footer-left"></div>
      <div class="footer-actions">
        <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
        <button type="submit" form="formProfesional" class="btn btn-success">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Cargar centros para selector M2M en modal si existe el contenedor
document.addEventListener('DOMContentLoaded', async () => {
  try{
    const modal = document.getElementById('modalForm');
    if(!modal) return;
    if(!document.getElementById('centrosSelect')){
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div style="grid-column:1 / -1;">
          <label>Centros</label>
          <select id="centrosSelect" multiple size="4" style="width:100%; padding:6px 10px;"></select>
        </div>
      `;
      const grid = modal.querySelector('form #direccion')?.closest('div')?.parentElement;
      if(grid){ grid.appendChild(wrapper.firstElementChild); }
    }
    const sel = document.getElementById('centrosSelect');
    if(sel && !sel.dataset.loaded){
      const r = await fetch('/centros/api/centros/?page_size=500', {credentials:'include'});
      if(r.ok){ const d = await r.json(); const list = Array.isArray(d)?d:(d.results||[]);
        sel.innerHTML = '';
        list.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=`${c.nombre} (${c.codigo})`; sel.appendChild(opt); });
        sel.dataset.loaded = '1';
      }
    }
  }catch(err){ console.error('centrosSelect init', err); }
});
</script>

<!-- Confirmación Eliminación -->
<div id="modalConfirm" class="modal">
  <div class="card modal-card" style="max-width:520px;">
    <div class="modal-header">
      <div class="title-wrap">
        <h2 style="margin:0; color:#fff;">Confirmar eliminación</h2>
        <p>Esta acción no se puede deshacer.</p>
      </div>
      <button type="button" class="modal-close" aria-label="Cerrar" onclick="document.getElementById('btnNo')?.click();">✕</button>
    </div>
    <div class="modal-body">
      <p>¿Seguro que querés eliminar este profesional?</p>
    </div>
    <div class="modal-footer">
      <div class="footer-left">
        <button id="btnNo" class="btn btn-secondary" type="button">Cancelar</button>
      </div>
      <div class="footer-actions">
        <button id="btnSi" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'JS/profesionales/spa2.js' %}?v=20251116"></script>
{% endblock %}
