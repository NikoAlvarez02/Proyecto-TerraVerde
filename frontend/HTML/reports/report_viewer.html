{% extends 'base.html' %}
{% load static %}

{% block title %}Generar Reporte | TerraVerde{% endblock %}
{% block topbar_title %}Generador de Reportes{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'CSS/reports.css' %}">
{% endblock %}

{% block content %}
  <div class="rp-page">
    <div class="rp-actions">
      <button class="btn btn-outline" onclick="history.back()">Volver</button>
      <a class="btn btn-primary" href="{% url 'reportes:dashboard' %}">Ir al Panel de Reportes</a>
    </div>

    <section class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <label>Documento:
        <select id="tipo">
          <option value="historia">Historia Clínica</option>
          <option value="epicrisis">Epicrisis</option>
          <option value="certificado">Certificado Médico</option>
        </select>
      </label>
      <label>Paciente:
        <select id="paciente_sel" style="min-width:260px"></select>
      </label>
      <span class="rangos">
        <label>Desde: <input id="desde" type="date"></label>
        <label>Hasta: <input id="hasta" type="date"></label>
      </span>
      <span class="cert" style="display:none; gap:6px;">
        <label>Diagnóstico: <input id="diag" type="text"></label>
        <label>Días de reposo: <input id="reposo" type="number" min="0" style="width:80px;"></label>
        <label>Profesional (opcional):
          <select id="prof_sel" style="min-width:220px"></select>
        </label>
      </span>
      <button id="btnGenerar" class="btn btn-primary">Generar</button>
    </section>

    <h2 class="rp-subtitle">Estadísticos</h2>
    <section class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <label>Estadística:
        <select id="est_tipo">
          <option value="atenciones">Gestión de Turnos y Asistencia</option>
          <option value="productividad">Desempeño por profesional</option>
          <option value="diagnosticos">Pacientes y Seguimiento Clínico</option>
        </select>
      </label>
      <label>Desde: <input id="est_desde" type="date"></label>
      <label>Hasta: <input id="est_hasta" type="date"></label>
      <button id="btnEst" class="btn btn-primary">Generar</button>
      <button id="btnEstCsv" class="btn btn-outline">Exportar CSV</button>
    </section>
    <section class="card">
      <h3 class="rp-subtitle">Resultado</h3>
      <div id="resultado" class="rp-result"></div>
    </section>
  </div>

  <script src="{% static 'JS/reports/pdf-export.js' %}"></script>
  <script>
    const tipoSel = document.getElementById('tipo');
    const pacSel = document.getElementById('paciente_sel');
    const profSel = document.getElementById('prof_sel');
    const spanRangos = document.querySelector('.rangos');
    const spanCert = document.querySelector('.cert');
    tipoSel.addEventListener('change', ()=>{
      const t = tipoSel.value;
      spanRangos.style.display = (t === 'historia' || t === 'epicrisis') ? 'inline-flex' : 'none';
      spanCert.style.display = (t === 'certificado') ? 'inline-flex' : 'none';
    });

    document.getElementById('btnGenerar').onclick = async ()=>{
      const t = tipoSel.value;
      const paciente_id = pacSel.value ? parseInt(pacSel.value) : NaN;
      if(!paciente_id){
        document.getElementById('resultado').textContent = 'Seleccione un paciente';
        return;
      }
      const params = { paciente: paciente_id, orientacion:'portrait', tamano_pagina:'A4' };
      let url = '';
      if (t === 'historia') {
        params.desde = document.getElementById('desde').value || undefined;
        params.hasta = document.getElementById('hasta').value || undefined;
        url = '/reportes/api/pacientes/';
      } else if (t === 'epicrisis') {
        params.desde = document.getElementById('desde').value || undefined;
        params.hasta = document.getElementById('hasta').value || undefined;
        url = '/reportes/api/pacientes/epicrisis/';
      } else if (t === 'certificado') {
        params.diagnostico = document.getElementById('diag').value || '';
        params.reposo_dias = document.getElementById('reposo').value || '';
        const prof = profSel.value;
        if (prof) params.profesional = parseInt(prof);
        url = '/reportes/api/pacientes/certificado/';
      }
      const res = await exportReportToPDF(url, params);
      const div = document.getElementById('resultado');
      if(res && (res.archivo_url || res.archivo_pdf)){
        const url = res.archivo_url || res.archivo_pdf;
        const optText = (tipoSel.options[tipoSel.selectedIndex]||{}).text || 'Reporte';
        renderDownloadAndAutoClear(url, optText);
      } else {
        div.textContent = (res && (res.error || res.detail)) ? (res.error || res.detail) : 'Error generando reporte';
      }
    };

    document.getElementById('btnEst').onclick = async ()=>{
      const t = document.getElementById('est_tipo').value;
      const body = { desde: document.getElementById('est_desde').value || undefined,
                     hasta: document.getElementById('est_hasta').value || undefined };
      let url = '';
      if (t === 'atenciones') url = '/reportes/api/estadisticas/atenciones/';
      if (t === 'productividad') url = '/reportes/api/estadisticas/productividad/';
      if (t === 'diagnosticos') url = '/reportes/api/estadisticas/diagnosticos/';
      const res = await exportReportToPDF(url, body);
      const div = document.getElementById('resultado');
      if(res && (res.archivo_url || res.archivo_pdf)){
        const url = res.archivo_url || res.archivo_pdf;
        const estSel = document.getElementById('est_tipo');
        const optText = (estSel.options[estSel.selectedIndex]||{}).text || 'Reporte';
        renderDownloadAndAutoClear(url, optText);
      } else {
        div.textContent = (res && (res.error || res.detail)) ? (res.error || res.detail) : 'Error generando reporte';
      }
    };

    document.getElementById('btnEstCsv').onclick = async ()=>{
      const t = document.getElementById('est_tipo').value;
      const desde = document.getElementById('est_desde').value || '';
      const hasta = document.getElementById('est_hasta').value || '';
      let url = '';
      if (t === 'atenciones') url = `/reportes/api/estadisticas/atenciones/datos/?desde=${encodeURIComponent(desde)}&hasta=${encodeURIComponent(hasta)}`;
      if (t === 'productividad') url = `/reportes/api/estadisticas/productividad/datos/?desde=${encodeURIComponent(desde)}&hasta=${encodeURIComponent(hasta)}`;
      if (t === 'diagnosticos') url = `/reportes/api/estadisticas/diagnosticos/datos/?desde=${encodeURIComponent(desde)}&hasta=${encodeURIComponent(hasta)}`;
      try{
        const r = await fetch(url, {credentials:'include'});
        if(!r.ok){ throw new Error(await r.text()); }
        const data = await r.json();
        const csv = jsonToCsv(t, data);
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `reporte_${t}.csv`;
        a.click();
      }catch(e){
        const div = document.getElementById('resultado');
        div.textContent = 'No se pudo exportar CSV';
      }
    };

    function jsonToCsv(tipo, data){
      const rows = [];
      if (tipo === 'atenciones'){
        rows.push(['centro','atenciones']);
        (data.por_centro||[]).forEach(it=> rows.push([it.centro__nombre||'N/A', it.c]));
      } else if (tipo === 'productividad'){
        rows.push(['profesional','atenciones']);
        (data.productividad||[]).forEach(it=> rows.push([
          `${it.profesional__apellido||''}, ${it.profesional__nombre||''}`.trim(), it.c
        ]));
      } else if (tipo === 'diagnosticos'){
        rows.push(['diagnostico','casos']);
        (data.por_cie10||[]).forEach(it=> rows.push([it.diagnostico_codigo||'N/A', it.c]));
      }
      return rows.map(r => r.map(v => String(v).replaceAll('"','""')).map(v=>`"${v}"`).join(',')).join('\n');
    }

    // Renderiza botón de descarga y, tras iniciar la descarga, limpia y refresca
    async function renderDownloadAndAutoClear(fileUrl, suggestedName){
      try{
        const div = document.getElementById('resultado');
        div.innerHTML = '';
        const btn = document.createElement('a');
        btn.className = 'btn btn-outline';
        btn.href = '#';
        btn.textContent = 'Descargar PDF';
        btn.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          try{
            const r = await fetch(fileUrl, {credentials:'include'});
            if(!r.ok) throw new Error('download');
            const blob = await r.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const base = (suggestedName || 'reporte')
              .toString().normalize('NFD').replace(/\p{Diacritic}/gu,'')
              .replace(/[^A-Za-z0-9_\- ]+/g,'').replace(/\s+/g,'_');
            a.download = `${base}.pdf`;
            document.body.appendChild(a);
            a.click();
            setTimeout(()=>{
              URL.revokeObjectURL(url);
              a.remove();
              div.textContent = '';
              location.reload();
            }, 400);
          }catch(e){
            // Fallback: abrir nueva pestaña y refrescar igual
            window.open(fileUrl, '_blank');
            setTimeout(()=>{ div.textContent=''; location.reload(); }, 600);
          }
        });
        div.appendChild(btn);
      }catch(e){ /* noop */ }
    }

    // Preseleccionar desde querystring (?est=productividad)
    (function initFromQuery(){
      try{
        const p = new URLSearchParams(location.search);
        const est = p.get('est');
        if (est){
          const estSel = document.getElementById('est_tipo');
          if ([...estSel.options].some(o=>o.value===est)){
            estSel.value = est;
            document.querySelector('.rp-subtitle').scrollIntoView({behavior:'smooth'});
          }
        }
      }catch(e){}
    })();
  </script>
  <script>
    // Cargar combos para evitar confusión con IDs
    async function apiJson(url){ const r = await fetch(url, {credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    (async ()=>{
      try{
        const [pacs, profs] = await Promise.all([
          apiJson('/pacientes/api/pacientes/'),
          apiJson('/profesionales/api/profesionales/')
        ]);
        pacSel.innerHTML = '<option value="">-- Seleccionar --</option>' + pacs.map(p=>`<option value="${p.id}">${p.apellido}, ${p.nombre} (${p.dni||''})</option>`).join('');
        profSel.innerHTML = '<option value="">-- Seleccionar --</option>' + profs.map(p=>`<option value="${p.id}">${p.apellido}, ${p.nombre}</option>`).join('');
      }catch(e){ console.error(e); }
    })();
  </script>
{% endblock %}
