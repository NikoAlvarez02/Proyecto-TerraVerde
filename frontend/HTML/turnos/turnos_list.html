{% extends "base.html" %}
{% load static %}

{% block title %}Turnos | TerraVerde{% endblock %}
{% block topbar_title %}Turnos{% endblock %}
{% block sidebar %}{% endblock %}

{% block content %}
<div class="main-wrap" style="display:flex; gap:24px;">
  <section class="contenido-principal" style="flex:1;">
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
        <h1 class="main-title" style="margin:0;">Listado de Turnos</h1>
        <button id="btnNuevo" class="btn btn-guardar">Nuevo Turno</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px; flex-wrap:wrap;">
        <label class="sr-only" for="t_q">Buscar</label>
        <input id="t_q" type="search" placeholder="Buscar paciente/profesional/motivo" style="padding:6px 10px; min-width:240px;" />

        <label class="sr-only" for="t_pac">Paciente</label>
        <select id="t_pac" style="padding:6px 10px; min-width:180px;"><option value="">Paciente (todos)</option></select>

        <label class="sr-only" for="t_prof">Profesional</label>
        <select id="t_prof" style="padding:6px 10px; min-width:180px;"><option value="">Profesional (todos)</option></select>

        <label class="sr-only" for="t_desde">Desde</label>
        <input id="t_desde" type="date" style="padding:6px 10px;" />

        <label class="sr-only" for="t_hasta">Hasta</label>
        <input id="t_hasta" type="date" style="padding:6px 10px;" />

        <label class="sr-only" for="t_estado">Estado</label>
        <select id="t_estado" style="padding:6px 10px;">
          <option value="">Todos</option>
          <option value="pendiente">Pendiente</option>
          <option value="confirmado">Confirmado</option>
          <option value="cancelado">Cancelado</option>
          <option value="atendido">Atendido</option>
          <option value="ausente">Ausente</option>
        </select>

        <label class="sr-only" for="t_orden">Orden</label>
        <select id="t_orden" style="padding:6px 10px;">
          <option value="-fecha_hora">M√°s recientes</option>
          <option value="fecha_hora">M√°s antiguos</option>
        </select>
        <div style="display:flex; gap:6px; align-items:center;">
          <button id="t_hoy" class="btn">Hoy</button>
          <button id="t_semana" class="btn">Semana</button>
          <button id="t_mes" class="btn">Mes</button>
        </div>
        <button id="t_buscar" class="btn">Filtrar</button>
        <button id="t_limpiar" class="btn btn-secundario">Limpiar</button>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table class="tabla-listado">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Paciente</th>
              <th>Profesional</th>
              <th>Estado</th>
              <th style="width:1%; white-space:nowrap;"></th>
            </tr>
          </thead>
          <tbody id="turnos-tbody">
            <tr><td colspan="6">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px;">
        <button id="t_prev" class="btn">Anterior</button>
        <span id="t_pageInfo" style="color:#666;"></span>
        <button id="t_next" class="btn">Siguiente</button>
      </div>

      <div id="flash" style="margin-top:12px; display:none;"></div>
    </div>
  </section>
</div>

<!-- Modal Crear/Editar -->
<div id="modalForm" class="modal">
  <div class="card modal-card">
    <div class="modal-header drag-handle">
      <div class="title-wrap">
        <h2 id="modalTitle" class="main-title" style="color:#fff;">Nuevo Turno</h2>
        <p>Agend√° o edita el turno con la informaci√≥n necesaria.</p>
      </div>
      <button id="btnCerrarModal" class="modal-close" aria-label="Cerrar modal">‚úï</button>
    </div>

    <div class="modal-body">
      <form id="formTurno" class="form-modal">
        {% csrf_token %}
        <input type="hidden" id="turnoId">

        <div class="form-grid">
          <div>
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" name="fecha" required>
          </div>
          <div>
            <label for="hora">Hora</label>
            <input type="time" id="hora" name="hora" required min="08:00" max="20:00">
          </div>
          <div class="full-width patient-selector">
            <label>Paciente *</label>
            <div class="search-input-container">
              <span class="search-icon">üîç</span>
              <input type="text" id="patientInput" class="patient-search-input" placeholder="Buscar paciente por nombre o DNI..." readonly onclick="openPatientSearch()">
              <button type="button" class="clear-patient" id="clearPatientBtn" onclick="clearSelectedPatient()">‚úï</button>
            </div>
            <div class="selected-patient-info" id="selectedPatientInfo">
              <div class="patient-info-header">
                <div class="patient-avatar-small" id="patientAvatarSmall"></div>
                <div class="patient-info-details">
                  <div class="patient-name-small" id="patientNameSmall"></div>
                  <div class="patient-details-small" id="patientDetailsSmall"></div>
                </div>
              </div>
            </div>
            <!-- select oculto para compatibilidad con js existente -->
            <select id="paciente" name="paciente" style="display:none;">
              <option value="">Cargando...</option>
            </select>
          </div>
          <div>
            <label for="profesional">Profesional</label>
            <select id="profesional" name="profesional" required>
              <option value="">Cargando...</option>
            </select>
          </div>
          <div>
            <label for="estado">Estado</label>
            <select id="estado" name="estado" required>
              <option value="pendiente">Pendiente</option>
              <option value="confirmado">Confirmado</option>
              <option value="atendido">Atendido</option>
              <option value="ausente">Ausente</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>
          <div class="full-width">
            <label for="motivo">Motivo</label>
            <input type="text" id="motivo" name="motivo" placeholder="Opcional">
          </div>
          <div class="full-width">
            <label for="observaciones">Observaciones</label>
            <textarea id="observaciones" name="observaciones" rows="3" placeholder="Opcional"></textarea>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <div class="footer-left"></div>
      <div class="footer-actions">
        <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
        <button type="submit" form="formTurno" class="btn btn-success">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmaci√≥n Eliminaci√≥n -->
<div id="modalConfirm" class="modal">
  <div class="card modal-card" style="max-width:520px;">
    <div class="modal-header">
      <div class="title-wrap">
        <h2 style="margin:0; color:#fff;">Confirmar eliminaci√≥n</h2>
        <p>Esta acci√≥n no se puede deshacer.</p>
      </div>
      <button type="button" class="modal-close" aria-label="Cerrar" onclick="document.getElementById('btnNo')?.click();">‚úï</button>
    </div>
    <div class="modal-body">
      <p>¬øSeguro que quer√©s eliminar este turno?</p>
    </div>
    <div class="modal-footer">
      <div class="footer-left">
        <button id="btnNo" class="btn btn-secondary" type="button">Cancelar</button>
      </div>
      <div class="footer-actions">
        <button id="btnSi" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal b√∫squeda de paciente -->
<div class="search-modal-overlay" id="patientSearchOverlay">
  <div class="search-modal">
    <div class="search-modal-header">
      <h3>üîç Buscar Paciente</h3>
      <button class="close-btn" type="button" onclick="closePatientSearch()">‚úï</button>
    </div>
    <div class="search-modal-body">
      <div class="search-input-container">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-box" id="patientSearchBox" placeholder="Buscar por nombre, apellido o DNI..." autocomplete="off">
      </div>
      <div class="filter-tabs" id="patientFilters">
        <button class="filter-tab active" data-filter="todos">üìã Todos</button>
        <button class="filter-tab" data-filter="recientes">üïê Recientes</button>
        <button class="filter-tab" data-filter="frecuentes">‚≠ê Frecuentes</button>
      </div>
      <div class="patient-list" id="patientList"></div>
      <button class="btn-new-patient" type="button" onclick="crearNuevoPaciente()">‚ûï Crear Nuevo Paciente</button>
    </div>
  </div>
</div>

<script src="{% static 'JS/turnos/spa.js' %}?v=13"></script>
{% endblock %}
