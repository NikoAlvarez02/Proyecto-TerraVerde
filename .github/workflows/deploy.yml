name: Deploy to VPS

on:
  push:
    branches:
      - main # o la rama que uses para desplegar

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # ----------------------------------------------------
            # Rutas cr√≠ticas
            # Rutas cr√≠ticas (¬°CORREGIDAS!)
            PROJECT_PARENT_DIR="/var/www/Proyecto-TerraVerde"
            PROJECT_ROOT="$PROJECT_PARENT_DIR/backend"
            VENV_ACTIVATE="$PROJECT_ROOT/.venv/bin/activate"
            # ----------------------------------------------------
            
            # Navegar al directorio padre
            cd $PROJECT_PARENT_DIR || exit 1
            set -e 

            echo "üåê Verificando y preparando el repositorio..."

            # SI EL DIRECTORIO DEL PROYECTO EXISTE, forzamos la actualizaci√≥n
            if [ -d "$PROJECT_ROOT" ]; then
                echo "üì¶ Directorio existente. Forzando actualizaci√≥n."
                cd $PROJECT_ROOT
                git reset --hard HEAD
                git pull
                cd .. # Volver al directorio padre
            # SI NO EXISTE, LO CLONAMOS LIMPIAMENTE
            else
                echo "‚ú® Directorio no encontrado. Clonando por primera vez."
                # Asume que el directorio ra√≠z de Git es el padre de 'backend'
                git clone https://github.com/NikoAlvarez02/Proyecto-TerraVerde.git
                cd Proyecto-TerraVerde/backend # Entrar al subdirectorio 'backend'
            fi
            
            # Navegar al directorio 'backend' para el resto de comandos
            cd $PROJECT_ROOT || exit 1

            echo "üêç Verificando entorno virtual..."
            # Paso 1: CREAR EL VENV SI NO EXISTE
            if [ ! -f "$VENV_ACTIVATE" ]; then
              echo "üêç El entorno virtual (.venv) no existe. Cre√°ndolo..."
              python3 -m venv .venv 
            fi

            echo "üêç Activando entorno virtual..."
            source $VENV_ACTIVATE
            
            echo "üîß Instalando dependencias..."
            pip install -r requirements.txt

            echo "üóÉÔ∏è Aplicando migraciones..."
            # Asume que ya tienes el .env con las credenciales correctas
            python manage.py migrate --noinput

            echo "üìÅ Recolectando archivos est√°ticos..."
            python manage.py collectstatic --noinput

            echo "üîÑ Reiniciando Gunicorn..."
            systemctl restart gunicorn

            echo "‚úÖ Reinicio de Gunicorn completo"

            echo "üß± (Opcional) Reiniciando Nginx..."
            systemctl reload nginx || echo "Nginx no recargado (no es cr√≠tico)"
