{% extends 'base.html' %}
{% load static %}

{% block title %}Generar Reporte | TerraVerde{% endblock %}
{% block topbar_title %}Generador de Reportes{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'CSS/reports.css' %}">
{% endblock %}

{% block content %}
  <div class="rp-page">
    <div class="rp-actions">
      <button class="btn btn-outline" onclick="history.back()">Volver</button>
      <a class="btn btn-primary" href="{% url 'reportes:dashboard' %}">Ir al Panel de Reportes</a>
    </div>

    <!-- Sección documentos -->
    <section id="docSection" class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <label>Documento:
        <select id="tipo">
          <option value="historia">Historia Clínica</option>
          <option value="epicrisis">Epicrisis</option>
          <option value="certificado">Certificado Médico</option>
        </select>
      </label>
      <label>Paciente:
        <select id="paciente_sel" style="min-width:260px"></select>
      </label>
      <span class="rangos">
        <label>Desde: <input id="desde" type="date"></label>
        <label>Hasta: <input id="hasta" type="date"></label>
      </span>
      <span class="cert" style="display:none; gap:6px;">
        <label>Diagnóstico: <input id="diag" type="text"></label>
        <label>Días de reposo: <input id="reposo" type="number" min="0" style="width:80px;"></label>
        <label>Profesional (opcional):
          <select id="prof_sel" style="min-width:220px"></select>
        </label>
      </span>
      <button id="btnGenerar" class="btn btn-primary">Generar PDF</button>
    </section>

    <!-- Sección estadísticas -->
    <section id="statsSection" class="card" style="display:none; gap:12px; align-items:flex-start; flex-wrap:wrap;">
      <div>
        <h2 class="rp-subtitle" id="statsTitle" style="margin:0;">Estadística</h2>
        <p style="margin:4px 0 0; color:#51646f;">Selecciona un rango para exportar</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <label>Desde: <input id="est_desde" type="date"></label>
        <label>Hasta: <input id="est_hasta" type="date"></label>
        <button id="btnStatsPdf" class="btn btn-primary">Exportar PDF</button>
        <button id="btnStatsExcel" class="btn btn-outline">Exportar Excel</button>
      </div>
    </section>

    <section class="card">
      <h3 class="rp-subtitle">Resultado</h3>
      <div id="resultado" class="rp-result"></div>
    </section>
  </div>

  <script src="{% static 'JS/reports/pdf-export.js' %}"></script>
  <script>
    const tipoSel = document.getElementById('tipo');
    const pacSel = document.getElementById('paciente_sel');
    const profSel = document.getElementById('prof_sel');
    const spanRangos = document.querySelector('.rangos');
    const spanCert = document.querySelector('.cert');
    const statsSection = document.getElementById('statsSection');
    const docSection = document.getElementById('docSection');
    const resultDiv = document.getElementById('resultado');

    tipoSel.addEventListener('change', ()=>{
      const t = tipoSel.value;
      spanRangos.style.display = (t === 'historia' || t === 'epicrisis') ? 'inline-flex' : 'none';
      spanCert.style.display = (t === 'certificado') ? 'inline-flex' : 'none';
    });

    document.getElementById('btnGenerar').onclick = async ()=>{
      const t = tipoSel.value;
      const paciente_id = pacSel.value ? parseInt(pacSel.value) : NaN;
      if(!paciente_id){
        resultDiv.textContent = 'Seleccione un paciente';
        return;
      }
      const params = { paciente: paciente_id, orientacion:'portrait', tamano_pagina:'A4' };
      let url = '';
      if (t === 'historia') {
        params.desde = document.getElementById('desde').value || undefined;
        params.hasta = document.getElementById('hasta').value || undefined;
        url = '/reportes/api/pacientes/';
      } else if (t === 'epicrisis') {
        params.desde = document.getElementById('desde').value || undefined;
        params.hasta = document.getElementById('hasta').value || undefined;
        url = '/reportes/api/pacientes/epicrisis/';
      } else if (t === 'certificado') {
        params.diagnostico = document.getElementById('diag').value || '';
        params.reposo_dias = document.getElementById('reposo').value || '';
        const prof = profSel.value;
        if (prof) params.profesional = parseInt(prof);
        url = '/reportes/api/pacientes/certificado/';
      }
      const res = await exportReportToPDF(url, params);
      if(res && (res.archivo_url || res.archivo_pdf)){
        const fileUrl = res.archivo_url || res.archivo_pdf;
        const a = document.createElement('a');
        a.href = fileUrl;
        a.target = '_blank';
        a.download = (tipoSel.options[tipoSel.selectedIndex]?.text || 'reporte') + '.pdf';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>a.remove(), 200);
        resultDiv.textContent = 'PDF generado y descargado';
      } else {
        resultDiv.textContent = (res && (res.error || res.detail)) ? (res.error || res.detail) : 'Error generando reporte';
      }
    };

    function mkCsv(tipo, data){
      const rows = [];
      if (tipo === 'atenciones'){
        rows.push(['centro','atenciones']);
        (data.por_centro||[]).forEach(it=> rows.push([it.centro__nombre||'N/A', it.c]));
      } else if (tipo === 'productividad'){
        rows.push(['profesional','atenciones']);
        (data.productividad||[]).forEach(it=> rows.push([
          `${it.profesional__apellido||''}, ${it.profesional__nombre||''}`.trim(), it.c
        ]));
      } else if (tipo === 'diagnosticos'){
        rows.push(['diagnostico','casos']);
        (data.por_cie10||[]).forEach(it=> rows.push([it.diagnostico_codigo||'N/A', it.c]));
      }
      return rows.map(r => r.map(v => String(v).replaceAll('"','""')).map(v=>`"${v}"`).join(',')).join('\\n');
    }

    // Inicializar para vistas de estadísticas directas
    (function initFromQuery(){
      try{
        const p = new URLSearchParams(location.search);
        const est = p.get('est');
        if (!est) return;
        docSection.style.display = 'none';
        statsSection.style.display = 'flex';
        const friendly = {
          atenciones: 'Gestión de Turnos y Asistencia',
          productividad: 'Productividad por Profesional',
          diagnosticos: 'Pacientes y Seguimiento Clínico'
        }[est] || 'Estadística';
        document.getElementById('statsTitle').textContent = friendly;

        document.getElementById('btnStatsPdf').onclick = async ()=>{
          const desdeVal = document.getElementById('est_desde').value;
          const hastaVal = document.getElementById('est_hasta').value;
          const payload = {};
          if (desdeVal) payload.desde = desdeVal;
          if (hastaVal) payload.hasta = hastaVal;
          try{
            const url = `/reportes/api/estadisticas/${est}/`;
            const res = await exportReportToPDF(url, payload);
            if(res && (res.archivo_url || res.archivo_pdf)){
              const fileUrl = res.archivo_url || res.archivo_pdf;
              const a = document.createElement('a');
              a.href = fileUrl;
              a.target = '_blank';
              a.download = `${friendly}.pdf`;
              document.body.appendChild(a);
              a.click();
              setTimeout(()=>a.remove(), 200);
              resultDiv.textContent = 'PDF generado y descargado';
            } else {
              resultDiv.textContent = (res && (res.error || res.detail)) ? (res.error || res.detail) : 'Ingrese fechas válidas';
            }
          }catch(e){
            resultDiv.textContent = 'Ingrese fechas válidas';
          }
        };

        document.getElementById('btnStatsExcel').onclick = async ()=>{
          const desde = document.getElementById('est_desde').value || '';
          const hasta = document.getElementById('est_hasta').value || '';
          const qs = [];
          if (desde) qs.push(`desde=${encodeURIComponent(desde)}`);
          if (hasta) qs.push(`hasta=${encodeURIComponent(hasta)}`);
          const url = `/reportes/api/estadisticas/${est}/datos/${qs.length ? '?' + qs.join('&') : ''}`;
          try{
            const r = await fetch(url, {credentials:'include'});
            if(!r.ok){ throw new Error(await r.text()); }
            const data = await r.json();
            const csv = mkCsv(est, data);
            // Entregamos en formato compatible con Excel (.xlsx usando MIME de Excel)
            const blob = new Blob([csv], {type:'application/vnd.ms-excel;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `estadistica_${est}.xlsx`;
            document.body.appendChild(a);
            a.click();
            setTimeout(()=>a.remove(), 200);
            resultDiv.textContent = 'Excel exportado';
          }catch(e){
            resultDiv.textContent = 'Ingrese fechas válidas';
          }
        };
      }catch(e){}
    })();

    // Cargar combos para documentos
    async function apiJson(url){ const r = await fetch(url, {credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    (async ()=>{
      try{
        const [pacs, profs] = await Promise.all([
          apiJson('/pacientes/api/pacientes/'),
          apiJson('/profesionales/api/profesionales/')
        ]);
        pacSel.innerHTML = '<option value=\"\">-- Seleccionar --</option>' + pacs.map(p=>`<option value=\"${p.id}\">${p.apellido}, ${p.nombre} (${p.dni||''})</option>`).join('');
        profSel.innerHTML = '<option value=\"\">-- Seleccionar --</option>' + profs.map(p=>`<option value=\"${p.id}\">${p.apellido}, ${p.nombre}</option>`).join('');
      }catch(e){ console.error(e); }
    })();
  </script>
{% endblock %}
