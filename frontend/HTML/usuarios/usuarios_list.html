{% extends "base.html" %}
{% load static %}

{% block title %}Usuarios | TerraVerde{% endblock %}
{% block topbar_title %}Usuarios{% endblock %}
{% block sidebar %}{% endblock %}

{% block content %}
<div class="main-wrap" style="display:flex; gap:24px;">
  <section class="contenido-principal" style="flex:1;">
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
        <h1 class="main-title" style="margin:0;">Usuarios</h1>
        <button id="btnNuevo" class="btn btn-guardar">Nuevo Usuario</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px;">
        <input id="u_q" type="search" placeholder="Buscar usuario / email" style="padding:6px 10px; min-width:240px;">
        <select id="u_orden" style="padding:6px 10px;">
          <option value="username">Usuario A-Z</option>
          <option value="-username">Usuario Z-A</option>
          <option value="email">Email A-Z</option>
          <option value="-date_joined">Mas recientes</option>
        </select>
        <button id="u_buscar" class="btn">Filtrar</button>
      </div>

      <div style="overflow:auto; margin-top:14px;">
        <table class="tabla-listado">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Activo</th>
              <th>Staff</th>
              <th style="width:1%; white-space:nowrap;"></th>
            </tr>
          </thead>
          <tbody id="usuarios-tbody">
            <tr><td colspan="6">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px;">
        <button id="u_prev" class="btn">Anterior</button>
        <span id="u_pageInfo" style="color:#666;"></span>
        <button id="u_next" class="btn">Siguiente</button>
      </div>

      <div id="flash" style="margin-top:12px; display:none;"></div>
    </div>
  </section>
</div>

<!-- Modal Crear/Editar -->
<div id="modalForm" class="modal">
  <div class="card modal-card">
    <div class="modal-header drag-handle">
      <div class="title-wrap">
        <h2 id="modalTitle" class="main-title" style="color:#fff;">Nuevo Usuario</h2>
        <p>Asigna credenciales, rol y permisos.</p>
      </div>
      <button id="btnCerrarModal" class="modal-close" aria-label="Cerrar modal">✕</button>
    </div>

    <div class="modal-body">
      <form id="formUsuario" class="form-modal">
        {% csrf_token %}
        <input type="hidden" id="usuarioId">

        <div class="form-grid">
          <div>
            <label>Username</label>
            <input type="text" id="username" name="username" required>
          </div>
          <div>
            <label>Email</label>
            <input type="email" id="email" name="email" required>
          </div>
          <div>
            <label>Nombre</label>
            <input type="text" id="first_name" name="first_name">
          </div>
          <div>
            <label>Apellido</label>
            <input type="text" id="last_name" name="last_name">
          </div>

          <div>
            <label>Password</label>
            <input type="password" id="password" name="password">
          </div>
          <div>
            <label>Confirmar Password</label>
            <input type="password" id="password2" name="password2">
          </div>

          <div>
            <label><input type="checkbox" id="is_active" name="is_active" checked> Activo</label>
          </div>
          <div>
            <label><input type="checkbox" id="is_staff" name="is_staff"> Staff</label>
          </div>
          <div class="col-span-2">
            <label><input type="checkbox" id="is_superuser" name="is_superuser"> Superusuario</label>
          </div>
        </div>

        <div class="col-span-2" style="grid-column:1 / -1; padding-top:8px; border-top:1px solid #eee;">
          <h3 style="margin:6px 0;">Perfil y Permisos</h3>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label>Rol</label>
            <select id="perfil_rol">
              <option value="recep">Recepcionista</option>
              <option value="prof">Profesional</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div>
            <label><input type="checkbox" id="pf_admin_usuarios"> Puede administrar usuarios</label>
          </div>
          <div>
            <label><input type="checkbox" id="pf_ver_pacientes" checked> Puede ver pacientes</label>
          </div>
          <div>
            <label><input type="checkbox" id="pf_ver_calendario" checked> Puede ver calendario</label>
          </div>
          <div>
            <label><input type="checkbox" id="pf_generar_reportes"> Puede generar reportes</label>
          </div>
          <div>
            <label><input type="checkbox" id="pf_ver_estadisticas"> Puede ver estadisticas</label>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <div class="footer-left"></div>
      <div class="footer-actions">
        <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
        <button type="submit" form="formUsuario" class="btn btn-success">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmacion Eliminacion -->
<div id="modalConfirm" class="modal">
  <div class="card modal-card" style="max-width:520px;">
    <div class="modal-header">
      <div class="title-wrap">
        <h2 style="margin:0; color:#fff;">Confirmar eliminación</h2>
        <p>Esta acción no se puede deshacer.</p>
      </div>
      <button type="button" class="modal-close" aria-label="Cerrar" onclick="document.getElementById('btnNo')?.click();">✕</button>
    </div>
    <div class="modal-body">
      <p>¿Seguro que queres eliminar este usuario?</p>
    </div>
    <div class="modal-footer">
      <div class="footer-left">
        <button id="btnNo" class="btn btn-secondary" type="button">Cancelar</button>
      </div>
      <div class="footer-actions">
        <button id="btnSi" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'JS/usuarios/spa.js' %}?v=3"></script>
{% endblock %}
