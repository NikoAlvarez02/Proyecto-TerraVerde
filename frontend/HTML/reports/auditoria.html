{% extends "base.html" %}
{% load static %}

{% block title %}Auditoria | TerraVerde{% endblock %}
{% block topbar_title %}Auditoria{% endblock %}
{% block sidebar %}{% endblock %}

{% block content %}
<style>
  .audit-shell{background:linear-gradient(140deg,#f5fff5,#eef7ee);padding:22px;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,0.08);}
  .audit-card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,0.06);border:1px solid #e6ece6;}
  .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;align-items:end;margin-bottom:14px;}
  .filter-grid label{font-weight:600;color:#215728;margin-bottom:4px;display:block;}
  .filter-grid input,.filter-grid select{padding:8px 10px;border:1px solid #cfe3cf;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.05);width:100%;}
  .filter-grid input:focus,.filter-grid select:focus{outline:none;border-color:#3d9a3d;box-shadow:0 0 0 3px rgba(61,154,61,0.15);}
  .btn-primary{background:#3d9a3d;color:#fff;}
  .btn-primary:hover{background:#2f7b2f;}
  .table-wrap{overflow:auto;border-radius:12px;border:1px solid #e6ece6;box-shadow:0 6px 16px rgba(0,0,0,0.05);}
</style>
<div class="audit-shell">
  <div class="audit-card">
    <h1 class="main-title" style="margin-top:0;">Visor de Auditoria</h1>
    <div class="filter-grid">
      <div>
        <label>Usuario</label>
        <select id="f_usuario">
          <option value="">(todas)</option>
        </select>
      </div>
      <div>
        <label>Accion</label>
        <select id="f_accion">
          <option value="">(todas)</option>
          <option value="create">Creacion</option>
          <option value="update">Actualizacion</option>
          <option value="delete">Eliminacion</option>
          <option value="export">Exportacion</option>
          <option value="report">Reporte</option>
          <option value="access">Acceso</option>
          <option value="login">Login</option>
          <option value="logout">Logout</option>
        </select>
      </div>
      <div>
        <label>Fecha desde</label>
        <input type="date" id="f_desde">
      </div>
      <div>
        <label>Fecha hasta</label>
        <input type="date" id="f_hasta">
      </div>
      <div>
        <label>Hora desde</label>
        <input type="time" id="f_hora_desde">
      </div>
      <div>
        <label>Hora hasta</label>
        <input type="time" id="f_hora_hasta">
      </div>
      <div style="grid-column: span 2;">
        <label>Busqueda</label>
        <input type="search" id="f_q" placeholder="ruta, detalle, modelo...">
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary" id="btnBuscar">Buscar</button>
        <button class="btn btn-guardar" id="btnPdf">Exportar PDF</button>
        <button class="btn btn-guardar" id="btnExcel">Exportar Excel</button>
      </div>
    </div>

    <div class="table-wrap">
      <table class="tabla-listado" id="tabla-audit">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Usuario</th>
            <th>Accion</th>
            <th>Modelo</th>
            <th>Objeto</th>
            <th>Ruta</th>
            <th>Metodo</th>
            <th>IP</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody id="audit-body">
          <tr><td colspan="9">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const body = document.getElementById('audit-body');
  const userSelect = document.getElementById('f_usuario');

  const qs = () => {
    const p = new URLSearchParams();
    const u = userSelect.value;
    const ac = document.getElementById('f_accion').value;
    const fd = document.getElementById('f_desde').value;
    const fh = document.getElementById('f_hasta').value;
    const hd = document.getElementById('f_hora_desde').value;
    const hh = document.getElementById('f_hora_hasta').value;
    const q = document.getElementById('f_q').value;
    if(u) p.set('usuario', u);
    if(ac) p.set('accion', ac);
    if(fd) p.set('fecha_desde', fd);
    if(fh) p.set('fecha_hasta', fh);
    if(hd) p.set('hora_desde', hd);
    if(hh) p.set('hora_hasta', hh);
    if(q) p.set('q', q);
    return p.toString();
  };

  async function loadUsers(){
    try{
      const r = await fetch('/usuarios/api/usuarios/?page_size=200&ordering=username', {credentials:'include'});
      if(!r.ok) throw new Error();
      const data = await r.json();
      const results = Array.isArray(data) ? data : (data.results || []);
      userSelect.innerHTML = '<option value=\"\">(todas)</option>';
      results.forEach(u=>{
        const nameParts = [u.first_name, u.last_name].filter(Boolean).join(' ').trim();
        const label = nameParts ? `${u.username} - ${nameParts}` : u.username;
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = label;
        userSelect.appendChild(opt);
      });
    }catch(e){
      // fallback keeps ID search if users endpoint fails
      userSelect.innerHTML = '<option value=\"\">(todas)</option>';
    }
  }

  async function loadData(){
    body.innerHTML = '<tr><td colspan=\"9\">Cargando...</td></tr>';
    try{
      const url = '/reportes/api/auditoria/?' + qs();
      const r = await fetch(url, {credentials:'include'});
      if(!r.ok) throw new Error('http '+r.status);
      const data = await r.json();
      if(!Array.isArray(data) || data.length===0){
        body.innerHTML = '<tr><td colspan=\"9\" style=\"text-align:center;color:#666;\">Sin resultados</td></tr>';
        return;
      }
      body.innerHTML = '';
      data.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.fecha || ''}</td>
          <td>${a.usuario || ''}</td>
          <td>${a.accion || ''}</td>
          <td>${a.modelo || ''}</td>
          <td>${a.objeto_id || ''}</td>
          <td>${a.ruta || ''}</td>
          <td>${a.metodo || ''}</td>
          <td>${a.ip || ''}</td>
          <td>${a.detalle || ''}</td>
        `;
        body.appendChild(tr);
      });
    }catch(e){
      body.innerHTML = '<tr><td colspan=\"9\" style=\"color:#c00;\">Error cargando auditorias</td></tr>';
    }
  }

  function exportar(tipo){
    const url = '/reportes/api/auditoria/?' + qs() + '&export=' + tipo;
    window.open(url, '_blank');
  }

  document.getElementById('btnBuscar').addEventListener('click', loadData);
  document.getElementById('btnPdf').addEventListener('click', ()=>exportar('pdf'));
  document.getElementById('btnExcel').addEventListener('click', ()=>exportar('xlsx'));

  loadUsers().finally(loadData);
})();
</script>
{% endblock %}
